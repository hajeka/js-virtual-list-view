function jsvlv(c,d,f,g){var j=-1,DOWN=1,KEY_CODE_UP=38,KEY_CODE_DOWN=40,KEY_CODE_ENTER=13,KEY_CODE_SPACE=32;var k=this,_elId=("vlv"+Math.round(Math.random()*1000000)),_t='<div id="<%= id %>" class="vlv-container"'+' style="width:<%=width %>px;height:<%=height %>px;"></div>',_$el=$(_.template(_t,{id:_elId,width:c,height:d})),_el=_$el[0],_container=null,_$content=$('<div class="vlv-content"></div>'),_content=_$content[0],_frozen=false,_viewportItems=[],_viewportStartIndex=0,_viewportEndIndex=-1,_contentHeight=0,_scrollDistance=0,_scrollDistancePending=0,_showing=false,_numberOfRows=f?f.numberOfRows():0,_indexOfFocused=-1,_averageRowHeight=0,_scrollableHeight=0,_scrollbar=null;g=g||{};g.onSelectRow=g.onSelectRow||function(){};g.onFocusRow=g.onFocusRow||function(){};g.onBlurRow=g.onBlurRow||function(){};scrollInfoDelegate={}scrollInfoDelegate.scrollHeight=function(){return 5000}scrollInfoDelegate.clientHeight=function(){return 300}function onItemClick(a,b){if(_frozen){return}g.onSelectRow(a,b)}function addContentClickHandler(a,b){b.addEventListener("click",function(e){onItemClick(a,b)},false)}function removeContentClickHandler(a,b){b.removeEventListener("click",function(e){onItemClick(a,b)},false)}function animateScrollDistance(){var a;if(Math.abs(_scrollDistancePending)<2){_scrollDistance+=_scrollDistancePending;_scrollDistancePending=0}else{a=Math.round(_scrollDistancePending*0.6);_scrollDistance+=a;_scrollDistancePending-=a}}function scroll(){var a,cIndex;animateScrollDistance();if(_scrollDistance<0){_content.style.top=_scrollDistance+"px";a=_viewportEndIndex+1;while(d-_scrollDistance-_contentHeight>0){if(a<_numberOfRows){cIndex=_viewportItems[a-1].index+1;push(cIndex);a++}else{if(_contentHeight>d){_scrollDistance=d-_contentHeight;_content.style.top=_scrollDistance+"px"}else{_content.style.top="0px";_scrollDistance=0}break}}}else if(_scrollDistance>0){_scrollDistance=0;_scrollDistancePending=0;_content.style.top="0px"}_scrollbar&&_scrollbar.set(-(_scrollDistance)/(_scrollableHeight-d));if(_scrollDistancePending!=0){requestAnimationFrame(scroll)}}function onscrollbarchanged(a){_scrollDistancePending+=(_scrollableHeight-d)*(-a)-_scrollDistance;requestAnimationFrame(scroll)}function onmousewheel(e){var a=e.wheelDeltaY||e.wheelDelta||-(e.detail);e.preventDefault();if(_frozen){return}e.stopPropagation();removeKeyboardFocus();_scrollDistancePending+=a;requestAnimationFrame(scroll)}function bindMousewheel(){if(typeof(document.onmousewheel)=="object"){document.body.addEventListener("mousewheel",onmousewheel,true)}else{}}function unbindMousewheel(){if(typeof(document.onmousewheel)=="object"){document.body.removeEventListener("mousewheel",onmousewheel,true)}else{}}function onmouseenter(e){if(!_frozen){_scrollbar&&_scrollbar.enable();e.preventDefault()}}function onmouseleave(e){_scrollbar&&_scrollbar.disable();e.preventDefault()}function onkeydown(e){var a=false;if(_frozen){return}switch(e.keyCode){case KEY_CODE_UP:moveKeyboardFocus(j);a=true;break;case KEY_CODE_DOWN:moveKeyboardFocus(DOWN);a=true;break;case KEY_CODE_ENTER:case KEY_CODE_SPACE:if(_indexOfFocused!=-1){g.onSelectRow(_viewportItems[_indexOfFocused].index,_viewportItems[_indexOfFocused].element);a=true}break}if(a){e.preventDefault();e.stopPropagation()}}function moveKeyboardFocus(a){var b,cIndex;if(_numberOfRows==0){return}else if(_numberOfRows==1){_indexOfFocused=0;g.onFocusRow(_viewportItems[_indexOfFocused].index,_viewportItems[_indexOfFocused].element)}else if(_indexOfFocused==-1){_indexOfFocused=firstVisibleIndex();g.onFocusRow(_viewportItems[_indexOfFocused].index,_viewportItems[_indexOfFocused].element)}else{b=_indexOfFocused+a;if(b>=0&&b<_numberOfRows){if(a==DOWN&&b>_viewportEndIndex){cIndex=_viewportItems[_viewportEndIndex].index+1;push(b)}g.onBlurRow(_viewportItems[_indexOfFocused].index,_viewportItems[_indexOfFocused].element);scrollToItemAtIndex(b);g.onFocusRow(_viewportItems[b].index,_viewportItems[b].element);_indexOfFocused=b}}}function removeKeyboardFocus(){if(_indexOfFocused!=-1){g.onBlurRow(_viewportItems[_indexOfFocused].index,_viewportItems[_indexOfFocused].element);_indexOfFocused=-1}}function firstVisibleIndex(){var a=-_scrollDistance,h=0,i=0;for(;i<_viewportItems.length;i++){if(h>=a){break}else{h+=_viewportItems[i].height}}return i}function scrollToItemAtIndex(a){var b=0,h=0,i=0,dy=0;for(;i<_viewportItems.length;i++){h=_viewportItems[i].height;if(i==a){break}else{b+=h}}if(b<-_scrollDistance){_scrollDistancePending+=-(_scrollDistance+b);requestAnimationFrame(scroll)}else if(h+b>(d-_scrollDistance)){_scrollDistancePending-=b+h-d+_scrollDistance;requestAnimationFrame(scroll)}}function push(a){var b=f.contentForRowAtIndex(a),h;_content.appendChild(b);h=$(b).outerHeight(true);_contentHeight+=h;_viewportItems.push({index:a,element:b,height:h});addContentClickHandler(a,b);_viewportEndIndex=a;_averageRowHeight=(_averageRowHeight*a+h)/(a+1);_scrollableHeight=_averageRowHeight*_numberOfRows}function unshift(a){var b=f.contentForRowAtIndex(a),h;_content.insertBefore(b,_content.firstChild);h=$(b).outerHeight(true)_contentHeight+=h;_viewportItems.unshift({index:a,element:b,height:h});addContentClickHandler(a,b);_viewportStartIndex=a}function pop(){var a=_viewportItems.pop();removeContentClickHandler(a.index,a.element);_content.removeChild(a.element);_contentHeight-=elementInfo.height;_viewportEndIndex--}function shift(a){var b=_viewportItems.shift();removeContentClickHandler(b.index,b.element);_content.removeChild(b.element);_contentHeight-=elementInfo.height;_viewportStartIndex++}function fill(){var a,h,i=0;while(_contentHeight<d&&i<_numberOfRows){push(i);i++};if(_scrollableHeight>d){_scrollbar=new jsvlvscrollbar(onscrollbarchanged);_el.appendChild(_scrollbar.getElement());_scrollbar.show()}}function reset(){removeKeyboardFocus();while(_content.firstChild){_content.removeChild(_content.firstChild)}_scrollbar&&_scrollbar.hide();_content.style.top="0px";_viewportItems=[];_viewportStartIndex=0;_viewportEndIndex=-1;_contentHeight=0;_scrollDistance=0;_numberOfRows=f?f.numberOfRows():0}k.getElement=function(){return _el}k.show=function(a){_el.appendChild(_content);_$el.bind("mouseenter",onmouseenter);_$el.bind("mouseleave",onmouseleave);bindMousewheel();document.addEventListener("keydown",onkeydown,true);a.appendChild(_el);_showing=true;_container=a;reset();fill()}k.hide=function(){_$el.unbind("mouseenter",onmouseenter);_$el.unbind("mouseleave",onmouseleave);unbindMousewheel();document.removeEventListener("keydown",onkeydown,true);if(_showing){_container&&_container.removeChild(_el);_showing=false}}k.reload=function(){reset();fill()}k.freeze=function(){_frozen=true;_scrollbar&&_scrollbar.disable()}k.unfreeze=function(){_frozen=false;_scrollbar&&_scrollbar.enable()}k.recalculateContentHeight=function(){_contentHeight=0;_averageRowHeight=0;_scrollableHeight=0;_viewportItems.forEach(function(a,b){h=$(a.element).outerHeight(true);a.height=h;_contentHeight+=h;_averageRowHeight=(_averageRowHeight*b+h)/(b+1);_scrollableHeight=_averageRowHeight*_numberOfRows});if(_scrollableHeight>d){if(_scrollbar){_scrollbar.show();_scrollbar.set(-(_scrollDistance)/(_scrollableHeight-d))}else{_scrollbar=new jsvlvscrollbar(onscrollbarchanged);_el.appendChild(_scrollbar.getElement());_scrollbar.show()}}else{_scrollDistance=0;_scrollbar&&_scrollbar.hide()}}k.dbgdmp=function(){var o={scrollDistance:_scrollDistance,scrollDistancePending:_scrollDistancePending,contentHeight:_contentHeight,firstIndex:_viewportStartIndex,lastIndex:_viewportEndIndex,indexOfFocused:_indexOfFocused,contentTop:_content.style.top};console.log(JSON.stringify(o))}return k}
